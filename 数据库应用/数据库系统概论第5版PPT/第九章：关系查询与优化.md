# 关系查询处理和查询优化

## 关系数据库系统的查询处理 

### 查询处理步骤

1. 查询分析：对查询语句进行**扫描**、**词法分析**和**语法分析**

2. 查询检查：

   - 合法权检查
   - 视图转换
   - 安全性检查
   - 完整性初步检查

   根据数据字典中有关的**模式**定义检查语句中的数据库对象，如关系名、属性名是否存在和有效 

   如果是对**视图**的操作，则要用**视图消解方法**把对视图的操作转换成对**基本表**的操作

   - 根据数据字典中的**用户权限和完整性约束**定义对用户的存取权限进行检查
   - 检查通过后把SQL**查询语句**转换成**内部表示**，即等价的**关系代数表达式**。
   - 关系数据库管理系统一般都用**查询树，也称为语法分析树**来表示扩展的**关系代数表达式**。

3. 查询优化 ：选择一个高效执行的查询处理策略 

   代数优化/逻辑优化：指关系代数表达式的优化
   物理优化：指存取路径和底层操作算法的选择

   查询优化的选择依据：
   基于规则(rule based)
   基于代价(cost based)
   基于语义(semantic based)

4. 查询执行：

   依据**优化器**得到的执行策略生成查询执行计划

   **代码生成器**(code generator)生成执行查询计划的代码 

   两种**执行方法**
   ：自顶向下
   ：自底向上

![image-20240229132105041](C:\Users\10263\AppData\Roaming\Typora\typora-user-images\image-20240229132105041.png)

####  实现查询操作的算法示例 

**选择**操作的实现

选择操作典型==实现方法==：

​	（1） 全表扫描方法 (Table Scan)

​	（2） 索引扫描方法 (Index Scan)

**连接**操作的实现 

连接操作是查询处理中最耗时的操作之一 
本节只讨论**等值连接(或自然连接)**最常用的实现算法 

（1）嵌套循环算法(nested loop join) 

（2）排序-合并算法(sort-merge join 或merge join)

（3）索引连接(index join)算法 

（4）Hash Join算法 

#### 关系数据库系统的查询优化 

开销？

集中式数据库：I/O ，CPU，内存

分布式数据库：I/O ，CPU，内存 + 通信

##### 一个实例：

[例9.3] 求选修了2号课程的学生姓名。



#### 代 数 优 化

##### ==关系代数表达式等价变换规则==

1. 连接、笛卡尔积交换律

2. 连接、笛卡尔积的结合律

3. 投影的串接定律

4. 选择的串接定律

5. 选择与投影操作的交换律

6. 选择与笛卡尔积的交换律

7. 选择与并的分配律

8. 选择与差运算的分配律

9. 选择对自然连接的分配律

10. 投影与笛卡尔积的分配律

11. 投影与并的分配律

##### 查询树的启发式优化

典型的启发式规则
（1）选择运算应尽可能先做**（选择先行）**
     在优化策略中这是**最重要、最基本**的一条。
（2）把投影运算和选择运算同时进行**（选投并行）**
如有若干投影和选择运算，并且它们都对同一个关系操作，则可以在扫描此关系的同时完成所有的这些运算以避免重复扫描关系。
（3） 把投影同其前或其后的双目运算结合起来，没有必要为了去掉某些字段而扫描一遍关系。
（4） 把某些选择同在它前面要执行的笛卡尔积结合起来成为一个连接运算，连接特别是等值连接运算要比同样关系上的笛卡尔积省很多时间。 
（5） 找出公共子表达式
	- 如果这种重复出现的子表达式的结果不是很大的关系
	- 并且从外存中读入这个关系比计算该子表达式的时间少得多
	- 则先计算一次公共子表达式并把结果写入中间文件是合算的。
	- 当查询的是视图时，定义视图的表达式就是公共子表达式的情况

遵循这些启发式规则，应用9.3.1的等价变换公式来优化关系表达式的算法

==**例子**==