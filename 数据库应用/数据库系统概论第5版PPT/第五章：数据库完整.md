## 数据库完整性

数据的**正确性**：是指数据是符合现实世界语义，反映了当前实际状况的

数据的**相容性**：是指数据库同一对象在不同关系表中的数据是符合逻辑的

为维护数据库的完整性，数据库管理系统必须：：

​	1.提供定义完整性约束条件的机制

​	2.提供完整性检查的方法

​	3.违约处理 



#### 实体完整性

实体完整性定义：CREATE  TABLE中用PRIMARY KEY定义

单属性构成的码有两种说明方法：定义为==列/表==级约束条件

对多个属性构成的码只有一种说明方法：定义为==表==级约束条件

实体完整性检查和违约处理：

1.插入或对主码列进行更新操作时，关系数据库管理系统按照实体完整性规则自动进行检查。

**包括**：检查主码值是否唯一，如果不唯一则拒绝插入或修改。

​			检查主码的各个属性是否为空，只要有一个为空就拒绝插入或修改

2.检查记录中主码值是否唯一的一种方法是进行全表扫描：（就是**查重**呗）

​			依次判断表中每一条记录的主码值与将插入记录上的主码值（或者修改的新主码值）是否相同 

3.表扫描缺点：耗时

​				为避免对基本表进行全表扫描，RDBMS核心一般都在主码上自动建立一个***索引**

​				B+树索引



#### 参照完整性

参照完整性定义：

​		在CREATE  TABLE中用FOREIGN KEY短语定义哪些列为外码

​		用REFERENCES短语指明这些外码参照哪些表的主码 

参照完整性检查和违约处理：

​	一个参照完整性将两个表中的相应元组**联系**起来

​	对被参照表和参照表进行增删改操作时有可能破坏参照完整性，必须进行**检查** 

![image-20240227135622669](C:\Users\10263\AppData\Roaming\Typora\typora-user-images\image-20240227135622669.png)





#### 用户定义的完整性

用户定义的完整性是：针对某一具体应用的数据必须满足的**语义要求** 

关系数据库管理系统提供了定义和检验用户定义完整性的机制，不必由应用程序承担

###### 属性上的约束条件

CREATE TABLE时定义属性上的约束条件	

列值非空（NOT NULL）

列值唯一（UNIQUE）

检查列值是否满足一个条件表达式（CHECK）

###### 属性上的约束条件检查和违约处理

​	插入元组或修改属性的值时，关系数据库管理系统检查属性上的约束条件是否被满足

​	如果不满足则操作被拒绝执行 

###### 元组上的约束条件

在CREATE TABLE时可以用CHECK短语定义元组上的约束条件，即元组级的限制

同属性值限制相比，元组级的限制可以设置**不同属性之间**的取值的相互约束条件 

###### 元组上的约束条件检查和违约处理

​	插入元组或修改属性的值时，关系数据库管理系统检查元组上的约束条件是否被满足

​	如果不满足则操作被拒绝执行 



#### 完整性约束命名子句

完整性约束命名子句：CONSTRAINT <完整性约束条件名><完整性约束条件>

<完整性约束条件>包括NOT NULL、UNIQUE、PRIMARY KEY短语、FOREIGN KEY短语、CHECK短语等



#### 断言（assert）

SQL中，可以使用 CREATE ASSERTION语句，通过声明性断言来指定更具一般性的约束。

可以定义涉及多个表的或聚集操作的比较复杂的完整性约束。

断言创建以后，任何对断言中所涉及的关系的操作都会触发关系数据库管理系统对断言的检查，任何使断言不为真值的操作都会被拒绝执行

创建断言：CREATE ASSERTION<断言名><CHECK 子句>

：每个断言都被赋予一个名字，<CHECK 子句>中的约束条件与WHERE子句的条件表达式类似。

删除断言：DROP ASSERTION <断言名>;

：如果断言很复杂，则系统在检测和维护断言的开销较高，这是在使用断言时应该注意的





#### 触发器

触发器（Trigger）是用户定义在关系表上的一类由事件驱动的特殊过程

：触发器保存在数据库服务器中

：任何用户对表的增、删、改操作均由服务器自动激活相应的触发器

：触发器可以实施更为复杂的检查和操作，具有更精细和更强大的数据控制能力

##### 定义触发器

![image-20240227144353130](C:\Users\10263\AppData\Roaming\Typora\typora-user-images\image-20240227144353130.png)

触发器又叫做**事件-条件-动作**（event-condition-action）规则。

当特定的系统事件发生时，对**规则的条件**进行检查，如果条件成立则执行规则中的动作，否则不执行该动作。

规则中的**动作体**可以很复杂，通常是一段SQL存储过程。

###### 定义触发器的语法说明

1.表的拥有者才可以在表上创建触发器

2.触发器名

​	：触发器名可以包含模式名，也可以不包含模式名
​	：同一模式下，触发器名必须是唯一的
​	：触发器名和表名必须在同一模式下

3.表名

​	：触发器只能定义在基本表上，不能定义在视图上

​	：当基本表的数据发生变化时，将激活定义在该表上相应触发事件的触发器

###### 触发事件

​	触发事件可以是INSERT、DELETE或UPDATE，也可以是这几个事件的组合

​	还可以UPDATE OF<触发列，...>，即进一步**指明修改哪些列**时激活触发器

​	AFTER/BEFORE是触发的时机

​	：AFTER表示在触发事件的操作执行之后激活触发器

​	：BEFORE表示在触发事件的操作执行之前激活触发器

###### 触发器类型

​	行级触发器（FOR EACH ROW）：表的行数

​	语句级触发器（FOR EACH STATEMENT）

###### 触发条件

​	触发器被激活时，只有当触发条件为真时触发动作体才执行;否则触发动作体不执行。

​	如果**省略WHEN**触发条件，则触发动作体在触发器激活后**立即执行**



##### 激活触发器

触发器的执行，是由触发事件激活的，并由数据库服务器自动执行

一个数据表上可能定义了多个触发器，遵循如下的执行顺序:

​	（1） 执行该表上的BEFORE触发器;
​	（2） 激活触发器的SQL语句;
​	（3） 执行该表上的AFTER触发器。 



##### 删除触发器 

删除触发器的SQL语法：DROP TRIGGER <触发器名> ON <表名>;

触发器必须是一个已经创建的触发器，并且只能由具有相应权限的用户删除。



![image-20240227150523185](C:\Users\10263\AppData\Roaming\Typora\typora-user-images\image-20240227150523185.png)