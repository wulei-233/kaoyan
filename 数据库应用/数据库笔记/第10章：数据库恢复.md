

# 数据库恢复技术

### 事务的基本概念

1.事务

事务(Transaction)是用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位。

事务vs程序
在关系数据库中，一个事务可以是**一条**SQL语句，**一组**SQL语句或整个程序
一个程序通常包含多个事务

事务是**恢复**和**并发控制**的基本单位

#### 定义事务

显式定义方式：

BEGIN TRANSACTION 

。。。

COMMIT  

或者

BEGIN TRANSACTION 

。。。

ROLLBACK

隐式方式：当用户没有显式地定义事务时，数据库管理系统按**缺省**规定**自动划分**事务

事务的ACID特性：

原子性（Atomicity）：事务是数据库的逻辑工作单位
一致性（Consistency）：事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态
隔离性（Isolation）：一个事务的执行不能被其他事务干扰（并发）
持续性（Durability ）：一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其执行结果有任何影响。（重做）

破坏事务ACID特性的因素：

（1） 多个事务并行运行时，不同事务的操作交叉执行

（2）事务在运行过程中被强行停止



 数据库恢复概述

数据库管理系统必须具有把数据库从错误状态恢复到某一已知的正确状态(亦称为一致状态或完整状态)的功能，这就是数据库的恢复管理系统对故障的对策

恢复子系统是数据库管理系统的一个重要组成部分 

恢复技术是衡量系统优劣的重要指标

故障的种类

1.事务内部的故障：

运算溢出
并发事务发生死锁而被选中撤销该事务
违反了某些完整性限制而被终止等

非预期的故障

2.系统故障：

称为软故障，是指造成系统停止运转的任何事件，使得
系统要重新启动。 

3.介质故障：

4.计算机病毒：

恢复的实现技术

恢复操作的基本原理：冗余

恢复机制涉及的关键问题

1. 如何建立冗余数据：数据转储（backup），登记日志文件（logging）

2. 如何利用这些冗余数据实施数据库恢复

数据转储：

（1）静态转储与动态转储

（2）海量转储与增量转储

（3）转储方法小结

登记日志文件：日志文件(log file)是用来记录事务对数据库的更新操作的文件

1. 日志文件的格式和内容
   ：以**记录**为单位的日志文件
   ：以**数据块**为单位的日志文件
2. 日志文件的作用
3. 登记日志文件

#### 恢复策略

##### 事务故障的恢复？

##### 系统故障的恢复？

##### 介质故障的恢复？

#### 具有检查点的恢复技术

- -在日志文件中增加检查点记录（checkpoint）
- 增加重新开始文件
- 恢复子系统在登录日志文件期间动态地维护日志

检查点记录的内容？

建立**检查点时刻**所有正在执行的事务清单
这些事务**最近一个日志记录**的地址

重新开始文件的内容？

记录各个检查点记录在日志文件中的地址

![image-20240229230512420](C:\Users\10263\AppData\Roaming\Typora\typora-user-images\image-20240229230512420.png)

动态维护日志文件的方法：

周期性地执行如下操作：建立检查点，保存数据库状态。

具体步骤是：
（1）将当前日志缓冲区中的所有日志记录写入磁盘的日志文件上
（2）在日志文件中写入一个检查点记录
（3）将当前数据缓冲区的所有数据记录写入磁盘的数据库中
（4）把检查点记录在日志文件中的地址写入一个重新开始文件

恢复子系统可以定期或不定期地建立检查点,保存数据库状态 

（本质就是 说明我现在是健康的，之后导致数据库不健康的东西都是正在运行的事务或者未来的事务）

![image-20240229231813454](C:\Users\10263\AppData\Roaming\Typora\typora-user-images\image-20240229231813454.png)

（1）从重新开始文件中找到最后一个检查点记录在日志文件中的地址，由该地址在日志文件中找到最后一个检查点记录

（2）由该检查点记录得到检查点建立时刻所有正在执行的事务清单ACTIVE-LIST

：建立两个事务队列UNDO-LIST ，REDO-LIST ：把ACTIVE-LIST暂时放入UNDO-LIST队列，REDO队列暂为空。

（3）从检查点开始正向扫描日志文件，直到日志文件结束
如有新开始的事务Ti，把Ti暂时放入UNDO-LIST队列
如有提交的事务Tj，把Tj从UNDO-LIST队列移到REDO-LIST队列;直到日志文件结束

（4）对UNDO-LIST中的每个事务执行UNDO操作，对REDO-LIST中的每个事务执行REDO操作

### 数据库镜像

数据库管理系统自动把整个数据库或其中的关键数据复制到另一个磁盘上

数据库管理系统自动保证镜像数据与主数据的一致性

：每当主数据库更新时，数据库管理系统自动把更新后的数据复制过去

![image-20240229232151832](C:\Users\10263\AppData\Roaming\Typora\typora-user-images\image-20240229232151832.png)

出现介质故障时：
可由镜像磁盘继续提供使用 
同时数据库管理系统自动利用镜像磁盘数据进行数据库的恢复
**不需要关闭系统**和**重装数据库副本**

![image-20240229232200728](C:\Users\10263\AppData\Roaming\Typora\typora-user-images\image-20240229232200728.png)

没有出现故障时

可用于并发操作
一个用户对数据加排他锁修改数据，其他用户可以读镜像数据库上的数据，而不必等待该用户释放锁 

## 小结

事务的概念和性质：

- 事务是数据库的逻辑工作单位

- 数据库管理系统保证系统中一切事务的原子性、一致性、隔离性和持续性，就保证了事务处于一致状态

故障的种类：

- 事务故障
- 系统故障
- 介质故障

恢复中最经常使用的技术：

- 数据库转储
- 登记日志文件

恢复的基本原理

利用存储在**后备副本**、**日志文件**和**数据库镜像**中的冗余数据来重建数据库

事务：

- 不仅是恢复的基本单位
- 也是并发控制的基本单位